#include "nanobench.h"
#include <arpa/inet.h>
#include <stdarg.h>
#include <stdint.h>
#include <stdio.h>
#include <unistd.h>

#include "JoinRequest.h"
#include "JoinResponse.h"

#include "CppUTest/TestHarness.h"

TEST_GROUP(JoinRequestTestsGroup){ //
                                   TEST_SETUP(){}

                                   TEST_TEARDOWN(){}
};

TEST(JoinRequestTestsGroup, JoinRequest_serialize_deserialize_perf) {
    ankerl::nanobench::Bench b;

    b.title("JoinRequest").warmup(1000).minEpochIterations(50000).relative(true);
    b.performanceCounters(true);

    uint8_t buffer[4096] = {};

    WritableWTPBoardData::SubElement wtpboarddata_elements[] = {
        { BoardDataSubElementHeader::Type::WTPModelNumber, "abcd" },
        { BoardDataSubElementHeader::Type::WTPSerialNumber, "efghijklm" },
    };
    WritableWTPBoardData wtpboarddata{ 1234, wtpboarddata_elements };

    EncryptionSubElement wtpdescriptor_encr_elements[] = { { 0 } };

    WritableWTPDescriptor::SubElement wtpdescriptor_descr_elements[] = {
        { 1234, DescriptorSubElementHeader::Type::ActiveSoftwareVersion, "abcd" },
        { 5678, DescriptorSubElementHeader::Type::BootVersion, "efghijklm" },
        { 9012,
          DescriptorSubElementHeader::Type::OtherSoftwareVersion,
          "01234567890ABCDEF01234567890ABCDEF01234567890ABCDEF01234567890ABCDEF" },
        { 3456, DescriptorSubElementHeader::Type::HardwareVersion, "1" }
    };

    WritableWTPDescriptor wtpdescriptor{ 10,
                                         4,
                                         wtpdescriptor_encr_elements,
                                         wtpdescriptor_descr_elements };

    WTPRadioInformation radio_infos[] = {
        { 0, false, false, false, false },
        { 1, true, true, false, false },
        { 2, false, false, false, false },
        { 3, true, true, false, true },
    };

    CAPWAPLocalIPv4Address ip_addresses[] = { { inet_addr("192.168.100.10") } };

    CapwapTransportProtocol capwap_transport_protocol{ CapwapTransportProtocol::Type::UDP };
    MaximumMessageLength maximum_message_length{ 65000 };
    WTPRebootStatistics wtp_reboot_statistics{
        100, 101, 1001, 1002, 333, 444, 555, WTPRebootStatistics::LastFailureType::LinkFailure
    };

    const uint8_t id[] = { 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
                           0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F };
    SessionId session_id;
    std::memcpy(session_id.session_id, id, sizeof(session_id.session_id));

    WTPFrameTunnelMode wtp_frame_tunnel_mode(true, false, false);

    WritableVendorSpecificPayloadArray vendor_specific_payloads;
    vendor_specific_payloads.Add(123456, 789, "01234567890ABCDEF0123");
    vendor_specific_payloads.Add(1, 2, "01234567890A");

    WritableJoinRequest write_data("location_data",
                                   wtpboarddata,
                                   wtpdescriptor,
                                   "wtp_name",
                                   session_id,
                                   wtp_frame_tunnel_mode,
                                   WTPMACType::Local_MAC,
                                   radio_infos,
                                   ECNSupport::Type::FullAndLimitedECN,
                                   ip_addresses,
                                   &capwap_transport_protocol,
                                   &maximum_message_length,
                                   &wtp_reboot_statistics,
                                   vendor_specific_payloads);

    b.run("serialization", [&] {
        RawData raw_data{ buffer, buffer + sizeof(buffer) };
        write_data.Serialize(&raw_data);
        ankerl::nanobench::doNotOptimizeAway(raw_data);

        raw_data = { buffer, buffer + 360 - (sizeof(ClearHeader) + sizeof(ControlHeader)) };
        ReadableJoinRequest read_data;
        CHECK_TRUE(read_data.Deserialize(&raw_data));
        ankerl::nanobench::doNotOptimizeAway(raw_data);
        CHECK_EQUAL(0, read_data.unknown_elements);
    });

    const uint8_t reference[] = {
        0x00, 0x10, 0xC2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x2A, 0x01, 0x58,
        0x00, 0x00, 0x1C, 0x00, 0x0D, 0x6C, 0x6F, 0x63, 0x61, 0x74, 0x69, 0x6F, 0x6E, 0x5F, 0x64,
        0x61, 0x74, 0x61, 0x00, 0x26, 0x00, 0x19, 0x00, 0x00, 0x04, 0xD2, 0x00, 0x00, 0x00, 0x04,
        0x61, 0x62, 0x63, 0x64, 0x00, 0x01, 0x00, 0x09, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6A, 0x6B,
        0x6C, 0x6D, 0x00, 0x27, 0x00, 0x78, 0x0A, 0x04, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x04,
        0xD2, 0x00, 0x01, 0x00, 0x04, 0x61, 0x62, 0x63, 0x64, 0x00, 0x00, 0x16, 0x2E, 0x00, 0x02,
        0x00, 0x09, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x00, 0x00, 0x23, 0x34,
        0x00, 0x03, 0x00, 0x44, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30,
        0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
        0x39, 0x30, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36,
        0x37, 0x38, 0x39, 0x30, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x30, 0x31, 0x32, 0x33, 0x34,
        0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x00, 0x00, 0x0D,
        0x80, 0x00, 0x00, 0x00, 0x01, 0x31, 0x00, 0x2D, 0x00, 0x08, 0x77, 0x74, 0x70, 0x5F, 0x6E,
        0x61, 0x6D, 0x65, 0x00, 0x23, 0x00, 0x10, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
        0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x00, 0x29, 0x00, 0x01, 0x02, 0x00, 0x2C,
        0x00, 0x01, 0x00, 0x04, 0x18, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x18, 0x00,
        0x05, 0x01, 0x00, 0x00, 0x00, 0x03, 0x04, 0x18, 0x00, 0x05, 0x02, 0x00, 0x00, 0x00, 0x00,
        0x04, 0x18, 0x00, 0x05, 0x03, 0x00, 0x00, 0x00, 0x0B, 0x00, 0x35, 0x00, 0x01, 0x01, 0x00,
        0x1E, 0x00, 0x04, 0xC0, 0xA8, 0x64, 0x0A, 0x00, 0x33, 0x00, 0x01, 0x02, 0x00, 0x1D, 0x00,
        0x02, 0xFD, 0xE8, 0x00, 0x30, 0x00, 0x0F, 0x00, 0x64, 0x00, 0x65, 0x03, 0xE9, 0x03, 0xEA,
        0x01, 0x4D, 0x01, 0xBC, 0x02, 0x2B, 0x02, 0x00, 0x25, 0x00, 0x1B, 0x00, 0x01, 0xE2, 0x40,
        0x03, 0x15, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x41, 0x42,
        0x43, 0x44, 0x45, 0x46, 0x30, 0x31, 0x32, 0x33, 0x00, 0x25, 0x00, 0x12, 0x00, 0x00, 0x00,
        0x01, 0x00, 0x02, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x41
    };
    b.run("reference sum", [&] {
        size_t sum = 0;
        for (size_t i = 0; i < sizeof(reference); i++) {
            sum += reference[i];
        }
        ankerl::nanobench::doNotOptimizeAway(sum);
    });
}
